steps:
  - checkout: self
    # find the commit hash on a quick non-forced update too
    fetchDepth: 10
  - script: |
      mkdir $BUILD_DIR && cd $BUILD_DIR
      cmake $(Build.SourcesDirectory) $(CMAKE_ARGS) \
      -DCMAKE_BUILD_TYPE="MinSizeRel" \
      -DCMAKE_CXX_FLAGS="$CMAKE_CXX_FLAGS" \
      -DPCL_ONLY_CORE_POINT_TYPES=ON \
      -DPCL_INDEX_SIGNED=OFF \
      -DPCL_INDEX_SIZE=64 \
      -DBUILD_2d=OFF \
      -DBUILD_features=OFF \
      -DBUILD_filters=OFF \
      -DBUILD_geometry=OFF \
      -DBUILD_io=OFF \
      -DBUILD_tools=OFF \
      -DBUILD_kdtree=OFF \
      -DBUILD_ml=OFF \
      -DBUILD_octree=ON \
      -DBUILD_outofcore=OFF \
      -DBUILD_people=OFF \
      -DBUILD_recognition=OFF \
      -DBUILD_registration=OFF \
      -DBUILD_sample_consensus=OFF \
      -DBUILD_search=OFF \
      -DBUILD_segmentation=OFF \
      -DBUILD_stereo=OFF \
      -DBUILD_surface=OFF \
      -DBUILD_tracking=OFF \
      -DBUILD_visualization=OFF \
      -DBUILD_global_tests=ON \
      -DBUILD_tests_2d=OFF \
      -DBUILD_tests_common=ON \
      -DBUILD_tests_features=OFF \
      -DBUILD_tests_filters=OFF \
      -DBUILD_tests_geometry=OFF \
      -DBUILD_tests_io=OFF \
      -DBUILD_tests_kdtree=OFF \
      -DBUILD_tests_keypoints=OFF \
      -DBUILD_tests_octree=OFF \
      -DBUILD_tests_outofcore=OFF \
      -DBUILD_tests_people=OFF \
      -DBUILD_tests_recognition=OFF \
      -DBUILD_tests_recognition=OFF \
      -DBUILD_tests_sample_consensus=OFF \
      -DBUILD_tests_search=OFF \
      -DBUILD_tests_segmentation=OFF \
      -DBUILD_tests_surface=OFF \
      -DBUILD_tests_visualization=OFF
      # Temporary fix to ensure no tests are skipped
      cmake $(Build.SourcesDirectory)
    displayName: 'CMake Configuration'
  - script: |
      cd $BUILD_DIR
      cmake --build . -- -j2
    displayName: 'Build Library'
  - script: |
      cd $BUILD_DIR && cmake --build . -- tests
    displayName: 'Run Unit Tests'
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'CTest'
      testResultsFiles: '**/Test*.xml'
      searchFolder: '$(Agent.BuildDirectory)/build'
    condition: succeededOrFailed()
